name: CI - Build Koharu (robust)

on:
  push:
    branches:
      - main
    paths:
      - 'src/all/koharu/**'
      - '.github/workflows/build_koharu_debug.yml'
  workflow_dispatch:

concurrency:
  group: build-koharu-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-koharu:
    name: Build koharu (debug, robust)
    runs-on: ubuntu-latest
    env:
      MODULE_PATH: src/all/koharu
      MODULE_TASK: :src:all:koharu:assembleDebug

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Show system info (for debugging)
        run: |
          echo "Runner: $(uname -a)"
          java -version
          ./gradlew --version

      - name: Provide persistent debug keystore
        run: |
          mkdir -p ~/.android
          echo "${{ secrets.DEBUG_KEYSTORE_B64 }}" | base64 -d > ~/.android/debug.keystore
          echo "==> CI Debug keystore fingerprint:"
          keytool -list -keystore ~/.android/debug.keystore \
            -storepass android -keypass android \
            -alias androiddebugkey -v | grep SHA1
          echo "==> Expected local SHA1:"
          echo "FB:61:0B:20:FC:1C:36:87:F9:FC:10:D4:82:B8:F1:72:C2:6B:65:D6"

      - name: Attempt normal build, fallback to skipping lint on failure
        id: build_step
        run: |
          set -euo pipefail
          echo "==> Running normal build for koharu"
          if ./gradlew $MODULE_TASK --no-daemon --console=plain; then
            echo "build_result=success" >> $GITHUB_OUTPUT
            echo "build_skipped_lint=false" >> $GITHUB_OUTPUT
          else
            echo "Normal build failed â€” attempting fallback build that skips lint tasks"
            if ./gradlew $MODULE_TASK -x lint -x lintKotlinMain -x lintKotlinTest --no-daemon --console=plain; then
              echo "build_result=success" >> $GITHUB_OUTPUT
              echo "build_skipped_lint=true" >> $GITHUB_OUTPUT
            else
              echo "Both normal and fallback builds failed. Exiting with non-zero."
              echo "build_result=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Collect koharu APKs
        id: collect
        run: |
          set -euo pipefail
          mkdir -p ci-artifacts
          echo "Searching for *-debug.apk under $MODULE_PATH"
          found=0
          while IFS= read -r apk; do
            found=1
            fname=$(basename "$apk")
            commitshort=${GITHUB_SHA:0:7}
            safe_module="koharu"
            dest="ci-artifacts/${safe_module}.${commitshort}__${fname}"
            cp "$apk" "$dest"
            echo "collected:$dest"
          done < <(find "$MODULE_PATH" -type f -name "*-debug.apk" -print)
          if [ "$found" -eq 0 ]; then
            echo "No debug APKs found under $MODULE_PATH. Listing build dirs for debugging:"
            find "$MODULE_PATH" -maxdepth 5 -type d -name build -print || true
            ls -R "$MODULE_PATH" || true
          fi
          ls -lah ci-artifacts || true

      - name: Upload koharu APKs (descriptive)
        uses: actions/upload-artifact@v4
        with:
          name: koharu-debug-apks-run-${{ github.run_number }}-${{ github.sha }}
          path: ci-artifacts/**
          retention-days: 7

      - name: Upload Gradle problems report (if any)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: koharu-gradle-problems-run-${{ github.run_number }}
          path: build/reports/problems/**
          retention-days: 7
